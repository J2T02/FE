// File: src/pages/Account/ForgotPasswordStepPage.jsx
import React, { useState, useEffect } from "react";
import {
  Form,
  Input,
  Button,
  Typography,
  Card,
  message,
  Row,
  Col,
  Steps,
} from "antd";
import {
  MailTwoTone,
  LockOutlined,
  SafetyCertificateOutlined,
  CheckCircleTwoTone,
  HeartTwoTone,
  ArrowLeftOutlined,
} from "@ant-design/icons";
import { motion } from "framer-motion";
import { useNavigate } from "react-router-dom";
import {
  forgotPasswordRequest,
  otpVerify,
  resetPassword,
} from "../../../apis/authService";
const { Title, Text } = Typography;

const ForgotPasswordStepPage = () => {
  const [step, setStep] = useState(0);
  const [otpCode, setOtpCode] = useState("123456");
  const [email, setEmail] = useState("");
  const [form] = Form.useForm();
  const [resendTimer, setResendTimer] = useState(0);
  const [passwordResetDone, setPasswordResetDone] = useState(false);
  const navigate = useNavigate();

  useEffect(() => {
    let timer;
    if (resendTimer > 0) {
      timer = setTimeout(() => setResendTimer(resendTimer - 1), 1000);
    }
    return () => clearTimeout(timer);
  }, [resendTimer]);

  const validatePassword = (_, value) => {
    if (!value || value.length < 8) {
      return Promise.reject("M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±");
    }
    if (!/[A-Za-z]/.test(value) || !/\d/.test(value)) {
      return Promise.reject("M·∫≠t kh·∫©u ph·∫£i bao g·ªìm ch·ªØ v√† s·ªë");
    }
    return Promise.resolve();
  };

  const handleEmailSubmit = async (values) => {
    try {
      const res = await forgotPasswordRequest({ emailOrPhone: values.email });
      if (res && res.data && res.data.success) {
        setEmail(values.email);
        setResendTimer(30);
        message.success(res.data.message || "ƒê√£ g·ª≠i m√£ OTP t·ªõi email");
        setStep(1);
      } else {
        message.error(res?.data?.message || "G·ª≠i m√£ OTP th·∫•t b·∫°i");
      }
    } catch (err) {
      message.error("G·ª≠i m√£ OTP th·∫•t b·∫°i");
    }
  };

  const handleResendOTP = async () => {
    if (!email) return;
    try {
      const res = await forgotPasswordRequest({ emailOrPhone: email });
      if (res && res.data && res.data.success) {
        setResendTimer(30);
        message.info(res.data.message || "ƒê√£ g·ª≠i l·∫°i m√£ OTP");
      } else {
        message.error(res?.data?.message || "G·ª≠i l·∫°i m√£ OTP th·∫•t b·∫°i");
      }
    } catch (err) {
      message.error("G·ª≠i l·∫°i m√£ OTP th·∫•t b·∫°i");
    }
  };

  const handleOTPSubmit = async (values) => {
    try {
      const res = await otpVerify({ emailOrPhone: email, otpCode: values.otp });
      if (res && res.data && res.data.success) {
        message.success(res.data.message || "X√°c nh·∫≠n m√£ OTP th√†nh c√¥ng!");
        setStep(2);
      } else {
        message.error(res?.data?.message || "M√£ OTP kh√¥ng ƒë√∫ng!");
      }
    } catch (err) {
      message.error("M√£ OTP kh√¥ng ƒë√∫ng!");
    }
  };

  const handleResetPassword = async (values) => {
    try {
      const res = await resetPassword({
        emailOrPhone: email,
        newPassword: values.newPassword,
      });
      if (res && res.data && res.data.success) {
        message.success(
          res.data.message || "M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t l·∫°i th√†nh c√¥ng!"
        );
        form.resetFields();
        setPasswordResetDone(true);
      } else {
        message.error(res?.data?.message || "ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th·∫•t b·∫°i!");
      }
    } catch (err) {
      message.error("ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th·∫•t b·∫°i!");
    }
  };

  const renderStep = () => {
    switch (step) {
      case 0:
        return (
          <Form layout="vertical" onFinish={handleEmailSubmit}>
            <Form.Item
              label="üìß Email"
              name="email"
              rules={[
                { required: true, message: "Vui l√≤ng nh·∫≠p email" },
                { type: "email", message: "Email kh√¥ng h·ª£p l·ªá" },
              ]}
            >
              <Input placeholder="example@domain.com" size="large" />
            </Form.Item>
            <Form.Item>
              <Button
                type="primary"
                htmlType="submit"
                size="large"
                block
                style={{
                  backgroundColor: "#ff85a2",
                  borderColor: "#ff85a2",
                  borderRadius: 10,
                  fontWeight: 600,
                }}
              >
                G·ª≠i m√£ OTP
              </Button>
            </Form.Item>
          </Form>
        );
      case 1:
        return (
          <Form layout="vertical" onFinish={handleOTPSubmit}>
            <Form.Item
              label="üîë M√£ OTP"
              name="otp"
              rules={[{ required: true, message: "Nh·∫≠p m√£ OTP b·∫°n nh·∫≠n ƒë∆∞·ª£c" }]}
            >
              <Input placeholder="Nh·∫≠p m√£ OTP" size="large" />
            </Form.Item>
            <Form.Item>
              <Button
                type="primary"
                htmlType="submit"
                size="large"
                block
                style={{
                  backgroundColor: "#ff85a2",
                  borderColor: "#ff85a2",
                  borderRadius: 10,
                  fontWeight: 600,
                }}
              >
                X√°c nh·∫≠n m√£ OTP
              </Button>
            </Form.Item>
            <div style={{ textAlign: "center" }}>
              {resendTimer > 0 ? (
                <Text type="secondary">G·ª≠i l·∫°i m√£ sau {resendTimer}s</Text>
              ) : (
                <Button
                  type="link"
                  onClick={handleResendOTP}
                  style={{ padding: 0 }}
                >
                  üîÅ G·ª≠i l·∫°i m√£ OTP
                </Button>
              )}
            </div>
          </Form>
        );
      case 2:
        if (passwordResetDone) {
          return (
            <div style={{ textAlign: "center", paddingTop: 20 }}>
              <CheckCircleTwoTone
                twoToneColor="#52c41a"
                style={{ fontSize: 60 }}
              />
              <Title level={4} style={{ color: "#52c41a", marginTop: 12 }}>
                M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t l·∫°i th√†nh c√¥ng!
              </Title>
              <Text style={{ display: "block", marginTop: 8, color: "#888" }}>
                M·∫π y√™u c√≥ th·ªÉ ƒëƒÉng nh·∫≠p l·∫°i b·∫±ng m·∫≠t kh·∫©u m·ªõi r·ªìi nh√© üíñ
              </Text>
              <Button
                type="primary"
                size="large"
                style={{
                  marginTop: 24,
                  backgroundColor: "#ff85a2",
                  borderColor: "#ff85a2",
                  borderRadius: 10,
                }}
                onClick={() => navigate("/")}
              >
                Quay v·ªÅ trang ƒëƒÉng nh·∫≠p
              </Button>
            </div>
          );
        }

        return (
          <Form form={form} layout="vertical" onFinish={handleResetPassword}>
            <div style={{ textAlign: "center", marginBottom: 16 }}>
              <CheckCircleTwoTone
                twoToneColor="#52c41a"
                style={{ fontSize: 40 }}
              />
            </div>
            <Form.Item
              label="üîê M·∫≠t kh·∫©u m·ªõi"
              name="newPassword"
              rules={[
                { required: true, message: "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u" },
                { validator: validatePassword },
              ]}
            >
              <Input.Password
                prefix={<LockOutlined />}
                placeholder="T·ªëi thi·ªÉu 8 k√Ω t·ª±, g·ªìm ch·ªØ v√† s·ªë"
                size="large"
              />
            </Form.Item>
            <Form.Item
              label="‚úÖ X√°c nh·∫≠n m·∫≠t kh·∫©u"
              name="confirmPassword"
              dependencies={["newPassword"]}
              rules={[
                { required: true, message: "Vui l√≤ng x√°c nh·∫≠n m·∫≠t kh·∫©u" },
                ({ getFieldValue }) => ({
                  validator(_, value) {
                    if (!value || getFieldValue("newPassword") === value) {
                      return Promise.resolve();
                    }
                    return Promise.reject("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!");
                  },
                }),
              ]}
            >
              <Input.Password
                prefix={<SafetyCertificateOutlined />}
                placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi"
                size="large"
              />
            </Form.Item>
            <Form.Item>
              <Button
                type="primary"
                htmlType="submit"
                block
                size="large"
                style={{
                  backgroundColor: "#ff85a2",
                  borderColor: "#ff85a2",
                  borderRadius: 10,
                  fontWeight: 600,
                }}
              >
                ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u
              </Button>
            </Form.Item>
          </Form>
        );
      default:
        return null;
    }
  };

  return (
    <div
      style={{
        minHeight: "100vh",
        background: "linear-gradient(to right, #fff0f5, #fff)",
        display: "flex",
        justifyContent: "center",
        alignItems: "center",
        padding: 32,
      }}
    >
      <Card
        style={{
          maxWidth: 1000,
          width: "100%",
          borderRadius: 24,
          overflow: "hidden",
          boxShadow: "0 10px 40px rgba(255, 105, 135, 0.2)",
          border: "1px solid #ffe0ec",
        }}
        bodyStyle={{ padding: 0 }}
      >
        <Row
          gutter={0}
          style={{
            height: "auto",
            minHeight: 500,
            display: "flex",
            flexWrap: "nowrap",
          }}
        >
          <Col
            xs={24}
            md={12}
            style={{
              backgroundColor: "#fff5f9",
              padding: 40,
              display: "flex",
              flexDirection: "column",
              justifyContent: "center",
              position: "relative",
            }}
          >
            {/* N√∫t quay l·∫°i */}
            <Button
              type="text"
              icon={<ArrowLeftOutlined />}
              style={{
                position: "absolute",
                top: 16,
                left: 16,
                fontWeight: "bold",
                color: "#d63384",
              }}
              onClick={() => navigate(-1)}
            >
              Quay l·∫°i
            </Button>

            <motion.div
              key={step}
              initial={{ opacity: 0, y: 30 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.6 }}
            >
              <div style={{ textAlign: "center", marginBottom: 24 }}>
                <Row justify="center" style={{ marginBottom: 12 }}>
                  <HeartTwoTone
                    twoToneColor="#ff6699"
                    style={{ fontSize: 42 }}
                  />
                </Row>
                <Title level={3} style={{ color: "#d63384", marginBottom: 8 }}>
                  Qu√™n m·∫≠t kh·∫©u
                </Title>
                <Text style={{ color: "#ff6699" }}>
                  M·∫π y√™u ƒë·ª´ng lo, ch√∫ng t√¥i lu√¥n s·∫µn s√†ng h·ªó tr·ª£ üíå
                </Text>
              </div>

              <Steps
                current={step}
                size="small"
                style={{ marginBottom: 24 }}
                items={[
                  {
                    title: "Email",
                    icon: <MailTwoTone twoToneColor="#eb2f96" />,
                  },
                  {
                    title: "X√°c nh·∫≠n OTP",
                    icon: <SafetyCertificateOutlined />,
                  },
                  { title: "ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u", icon: <LockOutlined /> },
                ]}
              />
              <Text
                style={{
                  display: "block",
                  textAlign: "center",
                  color: "#ff6699",
                  fontSize: 15,
                  marginBottom: 16,
                }}
              >
                {step === 0 && "üì© Vui l√≤ng nh·∫≠p email ƒë·ªÉ ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u"}
                {step === 1 && "üì® M√£ x√°c th·ª±c ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n"}
                {step === 2 && "üîê Vui l√≤ng ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u m·ªõi"}
              </Text>

              {renderStep()}
            </motion.div>
          </Col>

          <Col
            xs={0}
            md={12}
            style={{
              position: "relative",
              minHeight: 500,
              backgroundImage: `url("/doctorgroup.png")`,
              backgroundSize: "cover",
              backgroundPosition: "center",
              backgroundRepeat: "no-repeat",
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
            }}
          >
            <div
              style={{
                position: "absolute",
                inset: 0,
                backgroundColor: "rgba(255, 192, 203, 0.3)",
                zIndex: 1,
              }}
            />
          </Col>
        </Row>
      </Card>
    </div>
  );
};

export default ForgotPasswordStepPage;
